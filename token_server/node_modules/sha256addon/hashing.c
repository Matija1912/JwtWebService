#include <stdio.h>
#include "sha256.h"
#include "hmac_sha256.h"
#include <node_api.h>
#include <stdlib.h>

napi_value HmacSha256Wrapper(napi_env env, napi_callback_info info){
    size_t argc = 2;
    napi_value args[2];

    napi_get_cb_info(env, info, &argc, args, NULL, NULL);

    if (argc < 2) {
        napi_throw_error(env, NULL, "String argument required.");
        return NULL;
    }

    napi_valuetype arg_type1, arg_type2;
    napi_status status = napi_typeof(env, args[0], &arg_type1);
    if( arg_type1 != napi_string ){
        napi_throw_error(env, NULL, "First argument must be a string.");
        return NULL;
    }

    status = napi_typeof(env, args[1], &arg_type2);
    if( arg_type2 != napi_string ){
        napi_throw_error(env, NULL, "Second argument must be a string."); // Vracamo exception u JS exception sistem
        return NULL;
    }
    
    //extractanje message i key parametra
    size_t message_size;
    napi_get_value_string_utf8(env, args[0], NULL, 0, &message_size);
    char* message = (char*)malloc(message_size + 1);
    napi_get_value_string_utf8(env, args[0], message, message_size + 1, NULL);

    size_t key_size;
    napi_get_value_string_utf8(env, args[1], NULL, 0, &key_size);
    char* key = (char*)malloc(key_size + 1);
    napi_get_value_string_utf8(env, args[1], key, key_size + 1, NULL);


    uint8_t* hmac_result = hmac_sha256(message, key);
    free(message);
    free(key);

    // Convert binary result to a hex string
    char hex_string[65];  // 32 bytes * 2 chars per byte + null terminator
    for (int i = 0; i < 32; i++) {
        sprintf(&hex_string[i * 2], "%02x", hmac_result[i]);
    }
    hex_string[64] = '\0';  // Null-terminate the string

    free(hmac_result);

    // Create a JS string and return it
    napi_value result;
    napi_create_string_utf8(env, hex_string, NAPI_AUTO_LENGTH, &result);
    return result;

    // napi_value buffer;
    // void* data;
    // napi_create_buffer_copy(env, 32, hmac_result, &data, &buffer);
    // free(hmac_result);
    //return buffer;

}


// napi_value Sha256Wrapper(napi_env env, napi_callback_info info) {
//     size_t argc = 1;
//     napi_value args[1];
//     napi_get_cb_info(env, info, &argc, args, NULL, NULL);// popunimo argc sa argumentom koji predamo u js kodu kod poziva sha256()

//     if (argc < 1) {
//         napi_throw_error(env, NULL, "String argument required.");
//         return NULL;
//     }

//     size_t str_size;

//     napi_valuetype arg_type;
//     napi_status status = napi_typeof(env, args[0], &arg_type);
//     if (arg_type != napi_string) {
//         napi_throw_error(env, NULL, "Argument must be a string.");
//         return NULL;
//     }

//     napi_get_value_string_utf8(env, args[0], NULL, 0, &str_size);
//     char* input = (char*)malloc(str_size + 1);

//     napi_get_value_string_utf8(env, args[0], input, str_size + 1, NULL);
    
//     char* hash = sha256(input);
//     free(input);

//     napi_value buffer;
//     void* data;
//     napi_create_buffer_copy(env, 32, hash, &data, &buffer);
//     free(hash);

//     return buffer;
// }

napi_value Init(napi_env env, napi_value exports){
    napi_value sha256_func, hmac_sha256_func;
    // napi_create_function(env, NULL, 0, Sha256Wrapper, NULL, &sha256_func);
    // napi_set_named_property(env, exports, "sha256", sha256_func);

    napi_create_function(env, NULL, 0, HmacSha256Wrapper, NULL, &hmac_sha256_func);
    napi_set_named_property(env, exports, "hmac_sha256", hmac_sha256_func);
    return exports;
}

NAPI_MODULE(NODE_GYP_MODULE_NAME, Init);